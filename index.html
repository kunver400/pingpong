<!DOCTYPE html>
<head>
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<canvas id="acanvas" width="800" height="600">
</canvas>
</body>
<script src="color.js"></script>
<script>
        var background = new Image();
        background.src = "back2.png"; //background image
        var acanvas = document.getElementById('acanvas');
        var context = acanvas.getContext('2d');
        var Color = net.brehaut.Color;
        var mouseX,mouseY;

        const BALL_S = acanvas.width*acanvas.height/55555; //ball size
        const BALL_MOV = 8; //ball speed
        const COLLISION_OFFSET = 5; //compression on collision
        const FPS = 60; //redraw frequency
        const BALL_TRAIL = 6; //trail length
        const DEFLECTIONS = [1.7,1.5,1.2,-0.8,-0.5]
        ball_movx = BALL_MOV;
        ball_movy = BALL_MOV;
        var ballX = acanvas.width/2-BALL_S/2;
        var ballY = acanvas.height/2-BALL_S/2;
        var ball_comp = [
            // {color:'#51D6FF', arc_start:0, arc_end:360, rotation_speed:0, size_offset:0,rotaion:0},
            {color:'#E51A00', arc_start:0, arc_end:120, rotation_speed:3, size_offset:0,rotaion:0},
            {color:'#88FF51', arc_start:125, arc_end:240, rotation_speed:3, size_offset:0,rotaion:0},
            {color:'#51D6FF', arc_start:245, arc_end:360, rotation_speed:3, size_offset:0,rotaion:0},
        ];
        var ball_draw = true,ball_paint = true;//!draw-> stops movment !paint->stops paint

        const MISS_FOR = FPS*3;
        var missX=0, missY=0, missfor = MISS_FOR, miss_draw = false;

        const DASH_W = acanvas.width/1000;
        const DASH_H = acanvas.height/20;
        const DASH_GAP = acanvas.height/45;

        const BAR_WIDTH = acanvas.width/65;
        const BAR_HEIGHT = acanvas.height/4;
        const BAR_COLOR = Color('#FFFFFF').setAlpha(0.8);
        var lbarX=0, lbarY=-BAR_HEIGHT/2;
        var rbarX=acanvas.width - BAR_WIDTH, rbarY=-BAR_HEIGHT/2, lbar_speed=2;

        window.onload = function() {            
            setInterval(function() {
                bindEvents();
                drawAll();
                updatePositons();
            },1000/FPS);
        }
        function bindEvents()  {
        acanvas.addEventListener('mousemove',function(event) {
            mouseX = event.clientX;
            mouseY = event.clientY;
        });
        }

        function updatePositons() {
            //LPlayer mouse input
            mouseY && (lbarY = mouseY - BAR_HEIGHT/2);
            //RPlayer logic call
            rbarY = cpuPlaysR();
            if(ball_draw) {
                //ball diflection from canvas edge
                if(ballY >= acanvas.height-BALL_S-COLLISION_OFFSET || ballY <= BALL_S+COLLISION_OFFSET) {
                    ball_movy = -ball_movy;
                }
                if(ballX >= acanvas.width-BALL_S-COLLISION_OFFSET || ballX <= BALL_S+COLLISION_OFFSET) {
                    ball_movx = -ball_movx;
                }
                //ball diflection from bars
                var lbarCF = 2*Math.abs(ballY-lbarY-BAR_HEIGHT/2)/BAR_HEIGHT;
                var rbarCF = 2*Math.abs(ballY-rbarY-BAR_HEIGHT/2)/BAR_HEIGHT;
                if ((ballX < lbarX+BAR_WIDTH+BALL_S+COLLISION_OFFSET && lbarCF <= 1)||
                    (ballX > rbarX-BALL_S-COLLISION_OFFSET && rbarCF <= 1)) {
                    deflection = getDeflection(ballX < BAR_WIDTH+BALL_S+COLLISION_OFFSET? lbarCF: rbarCF);
                    ball_movx =  ball_movx*deflection.X;
                    ball_movy =  ball_movy*deflection.Y;
                }
                //recenter ball on miss
                else if(ballX <= lbarX+BAR_WIDTH+BALL_S+COLLISION_OFFSET
                 || ballX >= rbarX-BALL_S-COLLISION_OFFSET
                 ) {
                    ball_draw = false;
                    ball_paint = false;
                    missX = ballX+ball_movx; missY = ballY+ball_movy;
                    drawMiss();
                    setTimeout(resetBall,500);
                }
                ballX += ball_movx;
                ballY += ball_movy;
            }
            function getDeflection(barCF) {
                var factor;
                coefficent = Math.round(barCF*10)/10;
                switch (coefficent) {
                    case 0:
                        factor = DEFLECTIONS[4]; break;
                    case 1:
                        factor = DEFLECTIONS[0]; break;
                    case 0.9: case 0.8: case 0.7:
                        factor = DEFLECTIONS[1]; break;
                    case 0.6: case 0.5: case 0.4: case 0.3:
                        factor = DEFLECTIONS[2]; break;
                    default:
                        factor = DEFLECTIONS[3];
                }
                return {X:-1, Y:factor};
            }
            function cpuPlaysR() {
                if (rbarY+BAR_HEIGHT/2 > acanvas.height || rbarY < -BAR_HEIGHT/2)
                lbar_speed = -lbar_speed;
                return rbarY+lbar_speed;
            }
            function resetBall() {
                ballX = acanvas.width/2-BALL_S/2;
                ballY = acanvas.height/2-BALL_S/2;
                if(Math.abs(ball_movy)<2) // get random mov when movy too low.
                    ball_movy += (Math.floor(Math.random() * BALL_MOV*DEFLECTIONS[0]) -BALL_MOV*DEFLECTIONS[0])*(Math.abs(ball_movy)/ball_movy);
                ball_paint = true;
                setTimeout(function(){
                ball_movy = ball_movy/1.2;
                ball_draw = true;
                },500);
            }
        }


        function drawAll() {
            context.drawImage(background,0,0,background.width,background.height,0,0,acanvas.width,acanvas.height); 
            context.fillStyle = Color('#FFFFFF').setAlpha(0.2);
            context.fillRect(0,0,acanvas.width,acanvas.height);

            context.fillStyle = '#FFFFFF';
            for (i=0;i<acanvas.height;i+=DASH_H+DASH_GAP)
            context.fillRect(acanvas.width/2-DASH_W,i,DASH_W,DASH_H);

            context.fillStyle = Color('#000000').setAlpha(0); //Color: setting draw over to 0 alpha.
            ball_paint && drawBall(Number(BALL_TRAIL));
            miss_draw && drawMiss();
            drawLBars();
        }

        function drawBall(ball_trail,x=0,y=0) {
            if(ball_trail != 0) {
                ball_trail--;
                var trail_index = (BALL_TRAIL-ball_trail);
                drawBall(ball_trail,trail_index*ball_movx,trail_index*ball_movy);
            }
            ball_comp.forEach(function(arcObj)  {
                context.fillStyle = Color(arcObj.color).setAlpha(1/trail_index).setLightness(1/trail_index);
                context.beginPath();
                context.arc(ballX-x, ballY-y, BALL_S+arcObj.size_offset, (Math.PI*(arcObj.arc_start+arcObj.rotaion))/180, (Math.PI*(arcObj.arc_end+arcObj.rotaion))/180);
                context.lineTo(ballX-x, ballY-y);
                context.closePath();
                context.fill();
                if(trail_index == 1) {
                    arcObj.rotaion += arcObj.rotation_speed;
                }
            });
        }

        function drawLBars() {
            context.fillStyle = BAR_COLOR;
            context.fillRect(lbarX, lbarY, BAR_WIDTH,BAR_HEIGHT);
            context.fillRect(rbarX,rbarY,BAR_WIDTH,BAR_HEIGHT);
        }
        function drawMiss() {
            if (missfor-- != 0)
            {
                miss_draw = true;
                ball_comp.forEach(function(arcObj)  {
                context.fillStyle = Color('red').setAlpha(0.4).setLightness(0.8);
                context.beginPath();
                context.arc(missX, missY, 2*(BALL_S+arcObj.size_offset), (Math.PI*(arcObj.arc_start-10))/180, (Math.PI*(arcObj.arc_end-10))/180);
                context.lineTo(missX, missY);
                context.closePath();
                context.fill();
            });
            }
            else {
                missfor = MISS_FOR;
                miss_draw = false;
            }
        }
    </script>
</html>